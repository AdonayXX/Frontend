<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Descargar PDF de Viajes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
    <style>
        /* Estilos básicos */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #d6c6c6;
            text-align: center;
            /* Centra el botón */
        }

        #saveBtn {
            display: inline-block;
            /* Botón centrado */
            margin: 20px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            background-color: #155fad;
            color: white;
            border: none;
            border-radius: 4px;
        }

        /* Estilos para la tabla */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            color: #000;
            padding: 8px;
            text-align: left;
            word-wrap: break-word;
            /* Para que el texto se ajuste al ancho de la celda */
            max-width: 200px;
            /* Ancho máximo de la celda para evitar que el texto se extienda demasiado */
        }

        th {
            background-color: #004d84;
            color: #fff;
        }

    </style>
</head>

<body>
    <button id="saveBtn">Descargar como PDF</button>
    <div id="content">
      <!-- Contenido se agregará dinámicamente aquí -->
    </div>
    <script>
        document.getElementById('saveBtn').addEventListener('click', function () {
            fetch("https://backend-transporteccss.onrender.com/api/viaje")
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("La solicitud a la API no fue exitosa");
                    }
                    return response.json();
                })
                .then((data) => {
                    if (!data || !data.viaje || !Array.isArray(data.viaje)) {
                        throw new Error("Los datos recibidos de la API no son válidos");
                    }
                

                    // Generar dinámicamente el contenido de la tabla solo para los viajes
                    var tableHTML = "<h3>Caja Costarricense Seguro Social</h3>";
                    tableHTML += "<h3>Área de Salud Upala</h3>";
                    tableHTML += "<h3>Servicio Validación de Derechos - Transportes</h3>";
                    tableHTML += "<h3>Lista de Viajes Efectuados</h3>";
                    tableHTML += "<table>";
                    tableHTML += "<thead><tr><th>ID Viaje</th><th>Unidad</th><th>Chofer</th><th>Ocupación</th><th>Estado</th><th>Fecha Inicio</th><th>Fecha Fin</th><th>Destino</th><th>Citas Asociadas</th></tr></thead>";
                    tableHTML += "<tbody>";

                    // Construir filas de la tabla con los datos de los viajes
                    data.viaje.forEach(function (viaje) {
                        tableHTML += "<tr>";
                        tableHTML += "<td>" + viaje.idViaje + "</td>";
                        tableHTML += "<td>" + viaje.idUnidad + "</td>";
                        tableHTML += "<td>" + viaje.idChofer + "</td>";
                        tableHTML += "<td>" + viaje.Ocupacion + "</td>";
                        tableHTML += "<td>" + viaje.EstadoViaje+ "</td>";
                        tableHTML += "<td>" + new Date(viaje.fechaInicioViaje).toLocaleDateString() + "</td>";
                        tableHTML += "<td>" + new Date(viaje.Fecha_Fin).toLocaleDateString() + "</td>";
                        tableHTML += "<td>" + viaje.Destino + "</td>";
                        tableHTML += "<td>" + viaje.Citas_Asociadas + "</td>";
                        tableHTML += "</tr>";
                    });

                    tableHTML += "</tbody></table>";

                    // Crear un elemento temporal para convertirlo en PDF
                    var tempDiv = document.createElement("div");
                    tempDiv.innerHTML = tableHTML;

                    // Configuración de html2pdf
                    var opt = {
                        margin: 10, // Márgenes en mm
                        filename: "viajes.pdf",
                        image: { type: "jpeg", quality: 1.0 },
                        html2canvas: { scale: 3 },
                        jsPDF: { unit: "mm", format: "a3", orientation: "portrait" },
                    };

                    // Función para agregar imagen como logo en el PDF

                    function addLogoToPDF(pdf) {
                        var totalPages = pdf.internal.getNumberOfPages();
                        var logoWidth = 25; // Ancho de la imagen del logo en milímetros
                        var logoMarginX = 10; // Margen desde el borde izquierdo en milímetros
                        var logoMarginY = 5; // Margen desde el borde superior en milímetros

                        for (var i = 1; i <= totalPages; i++) {
                            pdf.setPage(i);
                            pdf.setFontSize(10);
                            pdf.text(`Página ${i} de ${totalPages}`, pdf.internal.pageSize.getWidth() - 50, pdf.internal.pageSize.getHeight() - 10); // Texto en la parte superior derecha

                            // Calcular posición de la imagen
                            var x = logoMarginX; // Posición X desde el borde izquierdo
                            var y = logoMarginY; // Posición Y desde el borde superior

                            // Ajustar tamaño de la imagen como logo en la esquina superior izquierda
                            pdf.addImage('img/logo_ccss_azul.png', 'PNG', x, y, logoWidth, 0); // Altura automática
                        }
                    }
                    // Crear PDF y descargarlo
                    html2pdf()
                        .from(tempDiv)
                        .set(opt)
                        .toPdf()
                        .get("pdf")
                        .then(function (pdf) {
                            addLogoToPDF(pdf);
                        })
                        .save();
                })
                .catch((error) =>
                    console.error(
                        "Error al obtener datos desde la API o al generar el PDF:",
                        error
                    )
                );
        });
    </script>
</body>
</html>